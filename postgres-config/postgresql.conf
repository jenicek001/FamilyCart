# PostgreSQL configuration optimized for FamilyCart UAT environment
# This configuration is optimized for a containerized environment with limited resources

# Connection and Authentication
listen_addresses = '*'
port = 5432
max_connections = 50                    # Reduced for UAT environment

# Memory Settings (optimized for container with 2GB limit)
shared_buffers = 256MB                  # 25% of available memory
effective_cache_size = 512MB            # Estimated available memory for caching
work_mem = 8MB                          # Memory for sorts/hashes
maintenance_work_mem = 64MB             # Memory for maintenance operations
max_wal_size = 512MB                    # Maximum WAL size
min_wal_size = 128MB                    # Minimum WAL size

# Checkpoint Settings
checkpoint_completion_target = 0.7      # Spread checkpoint I/O
checkpoint_timeout = 10min              # Maximum time between checkpoints

# Logging Settings
log_destination = 'stderr'
logging_collector = on
log_directory = '/var/lib/postgresql/data/log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000       # Log slow queries (>1s)
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_lock_waits = on                     # Log lock waits
log_statement = 'mod'                   # Log all modifications
log_temp_files = 10MB                   # Log temp files > 10MB

# Performance Settings
random_page_cost = 1.1                  # Assumes SSD storage
effective_io_concurrency = 200          # For SSD
max_worker_processes = 4                # Number of background worker processes
max_parallel_workers_per_gather = 2     # Parallel query workers
max_parallel_workers = 4                # Maximum parallel workers

# Autovacuum Settings (important for OLTP workloads)
autovacuum = on
autovacuum_max_workers = 2
autovacuum_naptime = 30s                # More frequent for active UAT
autovacuum_vacuum_threshold = 25        # Lower threshold for small tables
autovacuum_analyze_threshold = 25       # Lower threshold for small tables
autovacuum_vacuum_scale_factor = 0.1    # Vacuum when 10% of table is stale
autovacuum_analyze_scale_factor = 0.05  # Analyze when 5% of table changes

# WAL and Replication Settings
wal_level = replica                     # Enable replication if needed
wal_buffers = 16MB                      # WAL buffer size
synchronous_commit = on                 # Ensure durability
full_page_writes = on                   # Protect against partial page writes

# Query Planning
default_statistics_target = 100        # Statistics for query planning
constraint_exclusion = partition       # Enable partition constraint exclusion

# Locale and Formatting (adjust based on your requirements)
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# Security Settings
ssl = off                               # Disable SSL inside container (handled by nginx)
shared_preload_libraries = 'pg_stat_statements'  # Enable query statistics

# Extensions and Monitoring
pg_stat_statements.max = 1000           # Track top 1000 queries
pg_stat_statements.track = all          # Track all statements