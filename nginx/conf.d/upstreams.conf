# Upstream Server Configuration for FamilyCart Production
# File: /etc/nginx/conf.d/upstreams.conf
# Note: Moved to separate file to allow upstream definition in http context

# ============================================================================
# FamilyCart Production Upstreams
# ============================================================================

# FamilyCart Backend (FastAPI) - Production
upstream familycart_backend {
    # Backend server (Docker container on localhost:8000)
    server 127.0.0.1:8000 max_fails=3 fail_timeout=30s;
    
    # Keepalive connections for performance
    # 32 idle keepalive connections to backend
    keepalive 32;
    
    # Timeout for keepalive connections (60 seconds)
    keepalive_timeout 60s;
    
    # Maximum number of requests per keepalive connection
    keepalive_requests 100;
}

# FamilyCart Frontend (Next.js) - Production
upstream familycart_frontend {
    # Frontend server (Docker container on localhost:3000)
    server 127.0.0.1:3000 max_fails=3 fail_timeout=30s;
    
    # Keepalive connections for performance
    # 32 idle keepalive connections to frontend
    keepalive 32;
    
    # Timeout for keepalive connections (60 seconds)
    keepalive_timeout 60s;
    
    # Maximum number of requests per keepalive connection
    keepalive_requests 100;
}

# ============================================================================
# FamilyCart UAT Upstreams (Docker Compose services)
# ============================================================================

# FamilyCart Backend - UAT
upstream familycart_backend_uat {
    server uat-backend:8000 max_fails=3 fail_timeout=30s;
}

# FamilyCart Frontend - UAT
upstream familycart_frontend_uat {
    server uat-frontend:3000 max_fails=3 fail_timeout=30s;
}

# ============================================================================
# Monitoring Services
# ============================================================================

# Grafana/Prometheus
upstream grafana_service {
    server uat-prometheus:9090 max_fails=3 fail_timeout=30s;
}

# ============================================================================
# External Services
# ============================================================================

# Home Assistant (if needed)
upstream homeassistant_service {
    server 192.168.3.30:8123 max_fails=3 fail_timeout=30s;
}

# ============================================================================
# Upstream configuration notes:
# ============================================================================
# - keepalive: Maintains persistent connections to upstream servers
# - Benefits: Reduces latency, improves throughput, reduces CPU usage
# - Must set "proxy_http_version 1.1" and "proxy_set_header Connection ''" in location blocks
#
# Load balancing methods (if using multiple servers):
#   - round_robin (default): Distribute requests evenly
#   - least_conn: Send to server with fewest active connections
#   - ip_hash: Same client IP always goes to same server (session affinity)
#   - hash $request_uri consistent: Cache-friendly distribution
#
# Health checks (open-source alternative):
#   Use passive health checks with max_fails and fail_timeout:
#   server 127.0.0.1:8000 max_fails=3 fail_timeout=30s;
