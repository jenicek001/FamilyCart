# Rate Limiting Configuration for FamilyCart Production
# File: /etc/nginx/conf.d/rate-limiting.conf
# Note: These zones must be defined at the http level, not server level

# FamilyCart Production rate limiting zones
# API rate limiting zone - 10 requests per second per IP, 10MB zone (~160,000 IPs)
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

# Web frontend rate limiting zone - 30 requests per second per IP, 10MB zone (~160,000 IPs)
limit_req_zone $binary_remote_addr zone=web:10m rate=30r/s;

# UAT/Other services rate limiting zones (kept for compatibility)
limit_req_zone $binary_remote_addr zone=homeassistant:10m rate=15r/s;
limit_req_zone $binary_remote_addr zone=grafana:10m rate=20r/s;

# Connection upgrade map for WebSocket support (FamilyCart production)
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# Rate limiting configuration notes:
# - burst: Allow temporary bursts above the rate limit
# - nodelay: Process burst requests immediately (don't queue them)
# - delay: Queue requests up to the delay threshold, then apply nodelay
#
# Example usage in location blocks:
#   limit_req zone=api burst=20 nodelay;
#   limit_req zone=web burst=50 nodelay;
#
# To monitor rate limiting:
#   - Check error log for "limiting requests" messages
#   - Adjust rate/burst based on actual traffic patterns
