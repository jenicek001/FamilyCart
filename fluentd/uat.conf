# Fluentd configuration for FamilyCart UAT environment
# Collects logs from all services and forwards them to appropriate destinations

<system>
  log_level info
</system>

# Source: Backend container logs
<source>
  @type tail
  @id backend_logs
  path /fluentd/log/backend/*.log
  pos_file /fluentd/log/backend.log.pos
  tag familycart.backend
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
</source>

# Source: Frontend container logs  
<source>
  @type tail
  @id frontend_logs
  path /fluentd/log/frontend/*.log
  pos_file /fluentd/log/frontend.log.pos
  tag familycart.frontend
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
</source>

# Source: Nginx access logs
<source>
  @type tail
  @id nginx_access_logs
  path /fluentd/log/nginx/access.log
  pos_file /fluentd/log/nginx_access.log.pos
  tag familycart.nginx.access
  <parse>
    @type nginx
  </parse>
</source>

# Source: Nginx error logs
<source>
  @type tail
  @id nginx_error_logs
  path /fluentd/log/nginx/error.log
  pos_file /fluentd/log/nginx_error.log.pos
  tag familycart.nginx.error
  <parse>
    @type multiline
    format_firstline /^\d{4}/\d{2}/\d{2}/
    format1 /^(?<time>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?<log_level>\w+)\] (?<message>.*)/
  </parse>
</source>

# Filter: Add environment and service information
<filter familycart.**>
  @type record_transformer
  @id add_environment_info
  <record>
    environment "uat"
    service_name "${tag_parts[1]}"
    hostname "#{Socket.gethostname}"
  </record>
</filter>

# Filter: Parse and enhance backend API logs
<filter familycart.backend>
  @type record_transformer
  @id enhance_backend_logs
  <record>
    log_type "application"
    component "fastapi"
  </record>
</filter>

# Filter: Parse and enhance frontend logs
<filter familycart.frontend>
  @type record_transformer
  @id enhance_frontend_logs
  <record>
    log_type "application"
    component "nextjs"
  </record>
</filter>

# Filter: Parse and enhance nginx logs
<filter familycart.nginx.**>
  @type record_transformer
  @id enhance_nginx_logs
  <record>
    log_type "access"
    component "nginx"
  </record>
</filter>

# Output: Write all logs to stdout for container logging
<match familycart.**>
  @type stdout
  @id stdout_output
  <format>
    @type json
  </format>
</match>

# Output: Store logs in files for debugging (with rotation)
<match familycart.**>
  @type file
  @id file_output
  path /fluentd/log/aggregated/familycart-uat
  append true
  time_slice_format %Y%m%d%H
  time_slice_wait 10m
  time_format %Y-%m-%dT%H:%M:%S%z
  buffer_type file
  buffer_path /fluentd/log/buffer/
  flush_interval 30s
  <format>
    @type json
  </format>
</match>