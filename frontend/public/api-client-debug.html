<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Client Debug</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    pre {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
    }
    button {
      background-color: #0070f3;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      background-color: #f0f8ff;
      border-left: 5px solid #0070f3;
      border-radius: 3px;
    }
    .error {
      background-color: #fff0f0;
      border-left-color: #ff0000;
    }
    .heading {
      background-color: #eee;
      padding: 10px;
      margin-top: 30px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>API Client Debug Tool</h1>
  <p>This tool helps debug issues with the API client and trailing slashes.</p>
  
  <div class="heading">
    <h2>Test apiClient URLs</h2>
    <p>This will test various URLs with our custom trail slash logic</p>
  </div>
  
  <button id="test-api-client">Test API URLs</button>
  <button id="test-actual-requests">Make Real API Requests</button>
  
  <div id="api-client-result" class="result"></div>
  
  <div class="heading">
    <h2>Authentication Info</h2>
  </div>
  
  <button id="check-token">Check Current Token</button>
  <button id="test-direct-auth">Test Direct Auth API</button>
  
  <div id="auth-result" class="result"></div>

  <div class="heading">
    <h2>API Endpoints Test</h2>
  </div>
  
  <button id="test-fetch-api">Test Fetch API</button>
  <button id="test-xhr">Test XMLHttpRequest</button>
  <button id="test-options">Test OPTIONS Request</button>
  <button id="test-cors">Check CORS Setup</button>
  
  <div id="fetch-result" class="result"></div>
  
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // Import the main API client code for testing
    // Implementation of ensureTrailingSlash
    const ensureTrailingSlash = (url) => {
      const pathsNeedingSlash = [
        '/api/v1/shopping-lists',
        '/api/v1/items',
        '/api/v1/users/me',
      ];
      
      // Check if this URL starts with any path that needs a trailing slash
      for (const path of pathsNeedingSlash) {
        if (url === path || url.startsWith(path + '/') || url.startsWith(path + '?')) {
          // If it already has a slash or query parameter, don't change it
          if (url === path) {
            return url + '/';
          }
        } else if (url.startsWith(path)) {
          // This captures cases like '/api/v1/shopping-lists/123' or other subpaths
          const restOfUrl = url.substring(path.length);
          return `${path}/${restOfUrl}`;
        }
      }
      
      return url;
    };

    // Test URLs
    const urlsToTest = [
      '/api/v1/shopping-lists',
      '/api/v1/shopping-lists/',
      '/api/v1/shopping-lists/123',
      '/api/v1/shopping-lists?param=value',
      '/api/v1/users/me',
      '/api/v1/users/me/',
      '/api/v1/items',
      '/api/v1/items/',
      '/api/v1/items/123',
    ];

    // Test URL transformations
    document.getElementById('test-api-client').addEventListener('click', () => {
      const resultDiv = document.getElementById('api-client-result');
      let html = '<h3>URL Transformation Tests:</h3>';
      
      urlsToTest.forEach(url => {
        const transformed = ensureTrailingSlash(url);
        const changed = url !== transformed;
        html += `<div>
          <strong>${url}</strong> → ${transformed} 
          ${changed ? '<span style="color:green">(transformed)</span>' : '<span style="color:gray">(unchanged)</span>'}
        </div>`;
      });
      
      resultDiv.innerHTML = html;
    });      // Test actual API requests
    document.getElementById('test-actual-requests').addEventListener('click', async () => {
      const resultDiv = document.getElementById('api-client-result');
      resultDiv.innerHTML = '<h3>Making actual API requests...</h3>';
      
      const token = localStorage.getItem('token');
      if (!token) {
        resultDiv.innerHTML += '<div style="color:red">No authentication token found. Please login first.</div>';
        return;
      }
      
      const results = [];
      
      // Create a custom axios instance with our interceptor
      const apiClient = axios.create({
        timeout: 10000, // Add timeout to prevent hanging requests
      });
      
      // Add request interceptor for trailing slashes
      apiClient.interceptors.request.use(
        (config) => {
          if (config.url) {
            const originalUrl = config.url;
            config.url = ensureTrailingSlash(config.url);
            
            if (originalUrl !== config.url) {
              console.log(`API URL transformed: ${originalUrl} → ${config.url}`);
            }
          }
          
          // Add authorization header
          const token = localStorage.getItem('token');
          if (token) {
            config.headers.Authorization = `Bearer ${token}`;
          }
          
          // Log the final request details
          console.log(`Making request: ${config.method} ${config.url}`, config);
          
          return config;
        },
        (error) => {
          console.error('Request interceptor error:', error);
          return Promise.reject(error);
        }
      );
      
      // Add response interceptor for better logging
      apiClient.interceptors.response.use(
        (response) => {
          console.log(`Response from ${response.config.url}:`, response);
          return response;
        },
        (error) => {
          console.error(`Error response from ${error.config?.url}:`, error);
          return Promise.reject(error);
        }
      );
      
      // Test endpoints with protected data
      const endpoints = [
        '/api/v1/users/me',
        '/api/v1/shopping-lists'
      ];
      
      for (const endpoint of endpoints) {
        try {
          resultDiv.innerHTML += `<div>Testing GET ${endpoint}...</div>`;
          const response = await apiClient.get(endpoint);
          results.push({ 
            url: endpoint, 
            status: response.status,
            data: response.data
          });
          resultDiv.innerHTML += `<div style="color:green">✓ Success: ${endpoint} - Status ${response.status}</div>`;
        } catch (error) {
          results.push({ 
            url: endpoint, 
            status: error.response?.status || 'Error',
            error: error.message
          });
          resultDiv.innerHTML += `<div style="color:red">✗ Error: ${endpoint} - ${error.message}</div>`;
        }
      }
      
      resultDiv.innerHTML += `<h3>Results:</h3><pre>${JSON.stringify(results, null, 2)}</pre>`;
    });
    
    // Check token
    document.getElementById('check-token').addEventListener('click', () => {
      const resultDiv = document.getElementById('auth-result');
      const token = localStorage.getItem('token');
      
      if (token) {
        resultDiv.innerHTML = `
          <h3>Token Found:</h3>
          <div>Token starts with: ${token.substring(0, 15)}...</div>
          <div><strong>Full token:</strong> <pre>${token}</pre></div>
        `;
      } else {
        resultDiv.innerHTML = '<h3>No authentication token found</h3>';
      }
    });
    
    // Test direct authorization
    document.getElementById('test-direct-auth').addEventListener('click', async () => {
      const resultDiv = document.getElementById('auth-result');
      resultDiv.innerHTML = '<h3>Testing direct authorization...</h3>';
      
      const token = localStorage.getItem('token');
      if (!token) {
        resultDiv.innerHTML += '<div style="color:red">No authentication token found. Please login first.</div>';
        return;
      }
      
      try {
        // Try accessing a protected endpoint directly without our apiClient
        const response = await fetch('/api/v1/users/me/', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          resultDiv.innerHTML += `
            <div style="color:green">✓ Auth success! Status: ${response.status}</div>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `;
        } else {
          resultDiv.innerHTML += `
            <div style="color:red">✗ Auth failed! Status: ${response.status}</div>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `;
        }
      } catch (error) {
        resultDiv.innerHTML += `<div style="color:red">✗ Error: ${error.message}</div>`;
      }
    });
    
    // Test with fetch API
    document.getElementById('test-fetch-api').addEventListener('click', async () => {
      const resultDiv = document.getElementById('fetch-result');
      resultDiv.innerHTML = '<h3>Testing with native fetch API...</h3>';
      
      const token = localStorage.getItem('token');
      if (!token) {
        resultDiv.innerHTML += '<div style="color:red">No authentication token found. Please login first.</div>';
        return;
      }
      
      // Test all combinations of endpoints and options
      const endpoints = [
        { url: '/api/v1/users/me/', name: 'User info (with slash)' },
        { url: '/api/v1/users/me', name: 'User info (no slash)' },
        { url: '/api/v1/shopping-lists/', name: 'Shopping lists (with slash)' },
        { url: '/api/v1/shopping-lists', name: 'Shopping lists (no slash)' }
      ];
      
      const options = [
        { 
          name: 'Default fetch',
          config: { 
            headers: { 'Authorization': `Bearer ${token}` }
          }
        },
        { 
          name: 'With credentials',
          config: { 
            headers: { 'Authorization': `Bearer ${token}` },
            credentials: 'include'
          }
        },
        { 
          name: 'With redirect=manual',
          config: { 
            headers: { 'Authorization': `Bearer ${token}` },
            redirect: 'manual'
          }
        }
      ];
      
      const results = [];
      
      for (const endpoint of endpoints) {
        for (const option of options) {
          try {
            resultDiv.innerHTML += `<div>Testing ${endpoint.name} with ${option.name}...</div>`;
            
            const response = await fetch(endpoint.url, option.config);
            
            // Get response info before consuming the body
            const responseInfo = {
              status: response.status,
              statusText: response.statusText,
              redirected: response.redirected,
              url: response.url,
              type: response.type,
              headers: {}
            };
            
            // Get headers
            for (const [key, value] of response.headers.entries()) {
              responseInfo.headers[key] = value;
            }
            
            // Get body if possible
            let data = null;
            try {
              if (response.status !== 204) {
                data = await response.json();
              }
            } catch (e) {
              data = { error: `Could not parse JSON: ${e.message}` };
            }
            
            results.push({
              endpoint: endpoint.name,
              option: option.name,
              success: response.ok,
              response: responseInfo,
              data
            });
            
            resultDiv.innerHTML += response.ok 
              ? `<div style="color:green">✓ Success: ${endpoint.name} with ${option.name} - ${response.status}</div>`
              : `<div style="color:orange">⚠ Response not OK: ${endpoint.name} with ${option.name} - ${response.status}</div>`;
              
          } catch (error) {
            results.push({
              endpoint: endpoint.name,
              option: option.name,
              success: false,
              error: {
                message: error.message,
                name: error.name,
                stack: error.stack
              }
            });
            
            resultDiv.innerHTML += `<div style="color:red">✗ Error: ${endpoint.name} with ${option.name} - ${error.message}</div>`;
          }
        }
      }
      
      resultDiv.innerHTML += `<h3>Results:</h3><pre>${JSON.stringify(results, null, 2)}</pre>`;
    });
    
    // Test with XMLHttpRequest
    document.getElementById('test-xhr').addEventListener('click', () => {
      const resultDiv = document.getElementById('fetch-result');
      resultDiv.innerHTML = '<h3>Testing with XMLHttpRequest...</h3>';
      
      const token = localStorage.getItem('token');
      if (!token) {
        resultDiv.innerHTML += '<div style="color:red">No authentication token found. Please login first.</div>';
        return;
      }
      
      // Test endpoints with XHR which preserves auth headers during redirects
      const endpoints = [
        '/api/v1/shopping-lists',
        '/api/v1/shopping-lists/'
      ];
      
      const results = [];
      let completedRequests = 0;
      
      const checkAllDone = () => {
        if (completedRequests === endpoints.length) {
          resultDiv.innerHTML += `<h3>Results:</h3><pre>${JSON.stringify(results, null, 2)}</pre>`;
        }
      };
      
      endpoints.forEach(endpoint => {
        const xhr = new XMLHttpRequest();
        
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4) { // Request finished
            const result = {
              url: endpoint,
              status: xhr.status,
              statusText: xhr.statusText,
              responseURL: xhr.responseURL, // This shows the final URL after redirects
              redirected: xhr.responseURL !== endpoint
            };
            
            try {
              if (xhr.responseText) {
                result.data = JSON.parse(xhr.responseText);
              }
            } catch (e) {
              result.rawResponse = xhr.responseText;
              result.parseError = e.message;
            }
            
            results.push(result);
            completedRequests++;
            
            resultDiv.innerHTML += xhr.status >= 200 && xhr.status < 300
              ? `<div style="color:green">✓ Success: ${endpoint} - ${xhr.status}</div>`
              : `<div style="color:red">✗ Error: ${endpoint} - ${xhr.status} ${xhr.statusText}</div>`;
            
            checkAllDone();
          }
        };
        
        xhr.open('GET', endpoint, true);
        xhr.setRequestHeader('Authorization', `Bearer ${token}`);
        xhr.send();
      });
    });
    
    // Test OPTIONS requests to check CORS setup
    document.getElementById('test-options').addEventListener('click', async () => {
      const resultDiv = document.getElementById('fetch-result');
      resultDiv.innerHTML = '<h3>Testing OPTIONS requests...</h3>';
      
      const endpoints = [
        '/api/v1/users/me/',
        '/api/v1/shopping-lists/'
      ];
      
      const results = [];
      
      for (const endpoint of endpoints) {
        try {
          resultDiv.innerHTML += `<div>Testing OPTIONS for ${endpoint}...</div>`;
          
          // Make OPTIONS request using fetch
          const response = await fetch(endpoint, {
            method: 'OPTIONS',
            headers: {
              'Access-Control-Request-Method': 'GET',
              'Access-Control-Request-Headers': 'Authorization,Content-Type'
            }
          });
          
          const responseInfo = {
            status: response.status,
            statusText: response.statusText,
            headers: {}
          };
          
          // Get headers - focus on CORS headers
          for (const [key, value] of response.headers.entries()) {
            responseInfo.headers[key] = value;
          }
          
          results.push({
            endpoint,
            responseInfo,
            corsSuccess: !!responseInfo.headers['access-control-allow-origin']
          });
          
          const corsSuccess = !!responseInfo.headers['access-control-allow-origin'];
          resultDiv.innerHTML += corsSuccess
            ? `<div style="color:green">✓ CORS properly configured for ${endpoint}</div>`
            : `<div style="color:orange">⚠ CORS might not be properly configured for ${endpoint}</div>`;
            
        } catch (error) {
          results.push({
            endpoint,
            error: error.message
          });
          
          resultDiv.innerHTML += `<div style="color:red">✗ Error: ${endpoint} - ${error.message}</div>`;
        }
      }
      
      resultDiv.innerHTML += `<h3>Results:</h3><pre>${JSON.stringify(results, null, 2)}</pre>`;
    });
    
    // Test CORS setup with preflight
    document.getElementById('test-cors').addEventListener('click', async () => {
      const resultDiv = document.getElementById('fetch-result');
      resultDiv.innerHTML = '<h3>Testing CORS setup...</h3>';
      
      // Test CORS headers
      try {
        // Make a simple request that will trigger CORS preflight
        const corsResponse = await fetch('/api/v1/shopping-lists/', {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer test',
            'Content-Type': 'application/json',
            'X-Custom-Header': 'test' // This will trigger a preflight request
          }
        });
        
        resultDiv.innerHTML += `<div style="color:green">✓ CORS preflight successful</div>`;
        resultDiv.innerHTML += `<div>Status: ${corsResponse.status} ${corsResponse.statusText}</div>`;
        
        // Check response headers
        const corsHeaders = {
          'Access-Control-Allow-Origin': corsResponse.headers.get('access-control-allow-origin'),
          'Access-Control-Allow-Methods': corsResponse.headers.get('access-control-allow-methods'),
          'Access-Control-Allow-Headers': corsResponse.headers.get('access-control-allow-headers'),
          'Access-Control-Allow-Credentials': corsResponse.headers.get('access-control-allow-credentials')
        };
        
        resultDiv.innerHTML += `<div>CORS Headers: <pre>${JSON.stringify(corsHeaders, null, 2)}</pre></div>`;
      } catch (error) {
        resultDiv.innerHTML += `<div style="color:red">✗ CORS error: ${error.message}</div>`;
        resultDiv.innerHTML += `<div>This could indicate a CORS configuration issue on the backend.</div>`;
      }
    });
  </script>
</body>
</html>
